<app-navbar></app-navbar>

<div class="novo-agendamento-container">
  <div class="container">
    <div class="page-header">
      <h1>Novo Agendamento</h1>
    </div>

    <div class="gold-divider"></div>

    @if (erro) {
      <div class="alert alert-danger">
        {{ erro }}
      </div>
    }

    @if (sucesso) {
      <div class="alert alert-success">
        {{ sucesso }}
      </div>
    }

    <div class="agendamento-form-container">
      <form (ngSubmit)="agendar()">
        @if (authService.isAdmin()) {
          <div class="form-group">
            <label>Cliente *</label>
            <div class="cliente-selection">
              <div class="cliente-option">
                <input 
                  type="radio" 
                  id="cliente-existente" 
                  name="cliente-tipo" 
                  [value]="false"
                  [checked]="!criarNovoCliente"
                  (change)="criarNovoCliente = false"
                />
                <label for="cliente-existente">Cliente existente</label>
              </div>
              <div class="cliente-option">
                <input 
                  type="radio" 
                  id="cliente-novo" 
                  name="cliente-tipo" 
                  [value]="true"
                  [checked]="criarNovoCliente"
                  (change)="criarNovoCliente = true"
                />
                <label for="cliente-novo">Criar novo cliente</label>
              </div>
            </div>

            @if (!criarNovoCliente) {
              <button 
                type="button" 
                class="btn-selecionar-cliente"
                (click)="abrirModalCliente()"
              >
                @if (clienteSelecionado) {
                  <span class="cliente-info">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                    {{ getClienteSelecionadoNome() }}
                  </span>
                } @else {
                  <span class="cliente-placeholder">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="18" height="18">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Selecionar Cliente
                  </span>
                }
              </button>
            } @else {
              <div class="form-group">
                <label for="novo-cliente-nome">Nome do Cliente *</label>
                <input 
                  type="text" 
                  id="novo-cliente-nome" 
                  class="form-control" 
                  [(ngModel)]="novoClienteNome"
                  name="novoClienteNome"
                  placeholder="Nome completo"
                  required
                >
              </div>
              
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="novo-cliente-telefone">Telefone *</label>
                  <input 
                    type="tel" 
                    id="novo-cliente-telefone" 
                    class="form-control" 
                    [(ngModel)]="novoClienteTelefone"
                    name="novoClienteTelefone"
                    placeholder="(11) 99999-9999"
                    required
                  >
                </div>
                <div class="form-group">
                  <label for="novo-cliente-email">E-mail</label>
                  <input 
                    type="email" 
                    id="novo-cliente-email" 
                    class="form-control" 
                    [(ngModel)]="novoClienteEmail"
                    name="novoClienteEmail"
                    placeholder="cliente@email.com"
                  >
                </div>
              </div>

              <div class="grid grid-2">
                <div class="form-group">
                  <label for="novo-cliente-data-nascimento">Data de Nascimento</label>
                  <input 
                    type="date" 
                    id="novo-cliente-data-nascimento" 
                    class="form-control" 
                    [(ngModel)]="novoClienteDataNascimento"
                    name="novoClienteDataNascimento"
                  >
                </div>
                <div class="form-group">
                  <label for="novo-cliente-endereco">Endereço</label>
                  <input 
                    type="text" 
                    id="novo-cliente-endereco" 
                    class="form-control" 
                    [(ngModel)]="novoClienteEndereco"
                    name="novoClienteEndereco"
                    placeholder="Rua, número, bairro..."
                  >
                </div>
              </div>
            }
          </div>
        }

        <div class="grid grid-2">
          <div class="form-group">
            <label for="servico">Serviço *</label>
            <select 
              id="servico" 
              class="form-control" 
              [(ngModel)]="servicoId"
              name="servico"
              required
            >
              <option [ngValue]="null">Selecione um serviço</option>
              @for (servico of servicos; track servico.id) {
                <option [ngValue]="servico.id">
                  {{ servico.nome }} - R$ {{ formatarPreco(servico.preco) }} ({{ servico.duracao }}min)
                </option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="barbeiro">Barbeiro *</label>
            <select 
              id="barbeiro" 
              class="form-control" 
              [(ngModel)]="barbeiroId"
              name="barbeiro"
              required
            >
              <option [ngValue]="null">Selecione um barbeiro</option>
              @for (barbeiro of barbeiros; track barbeiro.id) {
                <option [ngValue]="barbeiro.id">
                  {{ barbeiro.nome }}
                </option>
              }
            </select>
          </div>

          <div class="form-group">
            <label for="data">Data *</label>
            <input 
              type="date" 
              id="data" 
              class="form-control" 
              [(ngModel)]="data"
              name="data"
              [min]="dataMinima"
              required
            >
          </div>

          <div class="form-group">
            <label for="hora">Horário *</label>
            <input 
              type="time" 
              id="hora" 
              class="form-control" 
              [(ngModel)]="hora"
              name="hora"
              required
            >
          </div>
        </div>

        <div class="form-group">
          <label for="observacoes">Observações (opcional)</label>
          <textarea 
            id="observacoes" 
            class="form-control" 
            [(ngModel)]="observacoes"
            name="observacoes"
            rows="4"
            placeholder="Alguma preferência ou observação..."
          ></textarea>
        </div>

        @if (getServicoSelecionado() || getBarbeiroSelecionado()) {
          <div class="resumo-card card">
            <h3>Resumo do Agendamento</h3>
            <div class="gold-divider"></div>
            
            @if (getServicoSelecionado(); as servico) {
              <div class="resumo-item">
                <span class="label">Serviço:</span>
                <span class="value">{{ servico.nome }}</span>
              </div>
              <div class="resumo-item">
                <span class="label">Valor:</span>
                <span class="value preco">R$ {{ formatarPreco(servico.preco) }}</span>
              </div>
              <div class="resumo-item">
                <span class="label">Duração:</span>
                <span class="value">{{ servico.duracao }} minutos</span>
              </div>
            }

            @if (getBarbeiroSelecionado(); as barbeiro) {
              <div class="resumo-item">
                <span class="label">Barbeiro:</span>
                <span class="value">{{ barbeiro.nome }}</span>
              </div>
              <div class="resumo-item">
                <span class="label">Especialidade:</span>
                <span class="value especialidade">{{ barbeiro.especialidade }}</span>
              </div>
            }

            @if (data && hora) {
              <div class="resumo-item">
                <span class="label">Data/Hora:</span>
                <span class="value">{{ data | date:'dd/MM/yyyy' }} às {{ hora }}</span>
              </div>
            }
          </div>
        }

        <div class="form-actions">
          <button 
            type="button" 
            class="btn btn-secondary" 
            (click)="cancelar()"
            [disabled]="carregando || carregandoCliente"
          >
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn"
            [class.btn-success]="sucessoCliente"
            [class.btn-primary]="!sucessoCliente"
            [disabled]="carregando || carregandoCliente"
          >
            @if (carregandoCliente) {
              <span class="btn-loading">Criando cliente...</span>
            } @else if (sucessoCliente) {
              <span class="btn-success-content">
                <svg class="success-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Cliente Cadastrado!
              </span>
            } @else if (carregando) {
              <span>Agendando...</span>
            } @else {
              <span>Confirmar Agendamento</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Seleção de Clientes -->
@if (modalClienteAberto) {
  <div class="modal-overlay" (click)="fecharModalCliente()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2>Selecionar Cliente</h2>
          <span class="modal-subtitle">
            {{ getClientesFiltrados().length }} {{ getClientesFiltrados().length === 1 ? 'cliente encontrado' : 'clientes encontrados' }}
          </span>
        </div>
        <button type="button" class="modal-close" (click)="fecharModalCliente()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <div class="modal-body">
        <div class="modal-search">
          <input 
            type="text" 
            class="search-input"
            placeholder="Buscar por nome, telefone ou e-mail..."
            [(ngModel)]="buscaCliente"
            (ngModelChange)="buscaCliente = $event"
            autofocus
          >
          <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>

        <div class="clientes-list">
          @if (getClientesFiltrados().length === 0) {
            <div class="empty-state">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="48" height="48">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <p>Nenhum cliente encontrado</p>
              <span class="empty-hint">Tente buscar com outros termos</span>
            </div>
          } @else {
            @for (cliente of getClientesFiltrados(); track cliente.id) {
              <div 
                class="cliente-item"
                [class.selected]="clienteId === cliente.id"
                (click)="selecionarCliente(cliente)"
              >
                <div class="cliente-avatar">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
                <div class="cliente-details">
                  <div class="cliente-nome">{{ cliente.nome }}</div>
                  <div class="cliente-info-secondary">
                    @if (cliente.telefone) {
                      <span class="info-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                        </svg>
                        {{ cliente.telefone }}
                      </span>
                    }
                    @if (cliente.email) {
                      <span class="info-item">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                        </svg>
                        {{ cliente.email }}
                      </span>
                    }
                  </div>
                </div>
                @if (clienteId === cliente.id) {
                  <div class="cliente-check">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                  </div>
                }
              </div>
            }
          }
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="fecharModalCliente()">
          Fechar
        </button>
      </div>
    </div>
  </div>
}

